---
title: MySQL 分区分表
date: 2018-02-26 18:05:49
tags: MySQL
---

## 1. MySQL 分区 && 分库分表

### 1. 分区表
分区表是一个独立的逻辑表，但是底层 MySQL 将其分成了多个物理子表，每一个分区表都会使用一个独立的表文件

客户端和 PHP 无感知，代码不需要修改，对业务逻辑没有任何影响

<!-- more -->

#### 1. 工作原理
创建表时使用 `partition by` 子句定义每个分区存放的数据，执行查询时，优化器会根据分区定义过滤那些没有所需数据的分区，这样查询只需要查询所需数据所在的分区即可，大大提高查询效率

分区的主要目的是将数据按照一个较粗的粒度分在不同的表中，这样可以将相关的数据存放在一起，而且如果想一次性删除整个分区的数据也很方便

#### 2. 适用场景
1. 表非常大，无法全部存在内存，或者只在表的最后有热点数据，其他都是历史数据
2. 分区表的数据更易维护，可以对独立的分区进行独立的操作
3. 分区表的数据可以分布在不同的机器上，从而高效使用资源
4. 可以使用分区表来避免某些特殊的瓶颈
5. 可以备份和恢复独立的分区

#### 3. 限制
1. 一个表最多只能有 1024 个分区
2. 5.1 版本，分区表表达式必须是整数，5.5 之后可以使用列分区
3. 分区字段如果有主键和唯一索引列，那么主键列和唯一列都必须包含进来
4. 分区表中无法使用外键约束
5. 需要对现有表的结构进行修改
6. 所有分区都必须使用相同的存储引擎
7. 可以使用的函数和表达式会有一些限制
8. 部分存储引擎不支持分区（InnoDB 和 MyISAM 都支持）
9. 对于 MyISAM 的分区表，不能使用 load index into cache，即不能将索引缓存
10. 对于 MyISAM 的分区表，使用分区表时需要打开更多的文件描述符，降低查询效率。

### 2. 分库分表
#### 1. 工作原理
通过一些 hash 算法或者工具实现将一张数据表垂直或者水平进行物理切分。

#### 2. 适用场景
1. 单表记录条数达到百万或者千万级别时
2. 解决表锁的问题

#### 3. 分表方式
##### 1. 水平分割
表很大，分割后可以降低在查询时需要读的数据和索引的页数，同时也降低了索引的层数，提高查询速度

###### 1. 使用场景
1. 表中的数据本身就有独立性，例如表中分别记录各个地区的数据或者不同时期的数据，特别是有些数据常用，有些不常用，比如切分历史数据和活跃数据
2. 需要把数据存放到多个介质上

###### 2. 缺点
1. 给应用增加复杂度，通常查询时需要多个表名，查询所有数据都需要 union 操作；
2. 在许多数据库应用中，这种复杂性会超过带来的优点，查询时会增加读一个索引层的磁盘次数；

##### 2. 垂直分表

把主键和一些列放在一张表，然后把主键和另外的列放在另一张表中

###### 1. 使用场景
1. 表中某些列常用，而另外一些列不常用
2. 可以使数据行变小，一个数据页能存储更多数据，查询时减少 I/O 次数

###### 2. 缺点
管理冗余列，查询所有数据都需要 join 操作


### 3. 分库分表缺点
1. 有些分表的策略基于应用层的逻辑算法，一旦逻辑算法改变，整个分表逻辑都会改变，扩展性较差
2. 对于应用层来说，逻辑算法无疑会增加开发成本



## 2. MySQL 复制原理及负载均衡

### 1. MySQL 主从复制工作原理

1. 在主库上把数据更改记录到二进制文件，即所有的写操作都记录到 binlog
2. 从库将主库的日志复制到自己的中继日志
3. 从库读取中继日志中的事件，将其重放到从库数据中，即执行了日志中的 SQL 语句


### 2. 解决了哪些问题
1. 数据分布：随意停止或开始复制，并在不同地理位置分布数据备份
2. 负载均衡：降低单个服务器的压力
3. 高可用和故障切换：帮助应用程序避免单点失败
4. 升级测试：可以使用更高版本的 MySQL 作为从库
