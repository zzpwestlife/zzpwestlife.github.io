---
title: 高并发大流量解决方案 11 web 服务器的负载均衡，请求分发
date: 2018-02-15 16:36:07
tags: 高并发
---


### 1. web 服务器的负载均衡，请求分发

#### 1.  #### 1. 七层负载均衡的实现

基于 url 等应用层信息的负载均衡

nginx 的 proxy 是它一个很强大的功能，实现了七层负载均衡

<!-- more -->

- 功能强大、性能卓越、运行稳定
- 配置简单灵活 upstream
- 能够自动剔除工作不正常的后端服务器
- 上传文件使用异步模式
- 支持多种分配策略，可以分配权重，分配方式灵活

> nginx 负载均衡

1. 内置策略: IP hash、加权轮询

- 加权轮询策略：首先将请求都分给高权重的机器，直到该机器的权值降到了比其他机器低，才开始将请求分给下一个高权重的机器。
当所有后端机器都 down 掉时，nginx 会立即将所有机器的标志位清成初始状态，以避免造成所有的机器都处于 timeout 状态。
- IP hash 策略：nginx 内置的另一个负载均衡的策略，流程和轮询很类似，只是其中的算法和具体的策略有些变化。IP hash 算法是一种变相的轮询算法

2. 扩展策略: fair 策略、通用 hash、一致性 hash

- fair 策略：根据后端服务器的响应时间判断负载情况，从中选出负载最轻的机器进行分流，有点类似 CDN 的原理。
- 通用 hash、一致性 hash：通用 hash 比较简单，可以以 nginx 内置的变量为 key 进行 hash，一致性 hash 采用了 nginx 内置的一致性 hash 环，支持 memcache


nginx 配置方案

``` nginx
http {
	# cluster 为集群名称
	upstream cluster {
		server srv1;
		server srv2;
		server srv3;
	}
	server {
		listen 80;
		location / {
			proxy_pass http://cluster;
		}
	}
}
```

#### 2. 四层负载均衡的实现

通过报文中的模板地址和端口，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器

lVS 实现服务器集群负载均衡有三种方式：NAT、DR 和 TUN


总结：大概思路，再细化

- 流量优化：防盗链处理；
- 前端优化：浏览器缓存，数据压缩，CDN 加速，独立图片服务器；
- 服务端：动态语言静态化，动态语言并发处理；
- 数据层：数据缓存，MySQL 优化；
- web 服务器负载均衡。
