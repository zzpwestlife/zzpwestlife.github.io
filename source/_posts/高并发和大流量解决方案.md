---
title: 高并发和大流量解决方案
date: 2018-02-15 16:28:43
tags: 高并发
---

这是慕课网相关课程的学习笔记，在此记录一下，方便查阅。

> 真题：PHP如何解决网站大流量和高并发的问题？

1. 考点
- 高并发架构相关概念
- 高并发解决方案案例

<!-- more -->

### 1. 高并发架构相关概念

#### 1. 并发

> 在操作系统中，是指一个时间段中有几个程序都处于已启动运行到运行完毕之间，且这几个程序都是在同一个处理机上运行，但任意时刻点上只有一个程序在处理机上运行。

我们所说的高并发：在互联网时代，所讲的并发、高并发，通常是指并发访问。也就是在摸个时间点，有多少个访问同时到来。

通过一个系统的日PV在千万以上，有可能是一个高并发的系统。

高并发具体应该关心什么？

- QPS：每秒请求或者查询的数量，在互联网领域，指每秒响应请求数（指http请求）；
- 吞吐量：单位时间内处理的请求数量（通常由QPS和并发数决定）；
- 响应时间：从请求发出到收到响应花费的时间。例如一个系统处理一个http请求需要100ms，这个100ms就是系统的响应时间；
- PV：综合浏览量 page view， 即页面的浏览量或者点击量，访客在24小时内访问的页面数量。刷新页面不计入，同一访客浏览同一网页页面，只记作一次PV；
- UV：独立访客 unique visitor；
- 带宽：计算带宽大小需关注两个指标，峰值流量和页面的平均大小，峰值一般是平均值的倍数，根据实际情况来定；
- 日网站带宽： PV/统计时间（s）\* 平均页面大小（KB）\* 8


> 注意： QPS 不等于 并发连接数。QPS是每秒http请求数量，并发连接数是系统同时处理的请求数量。

峰值每秒请求数(QPS) = (总PV数 * 80%)/(6小时秒数 * 20%)  即80% 的访问量集中在20% 的时间内。二八定律

压力测试：
- 测试能承受的最大并发数；
- 测试最大承受的QPS值。
- 

常用性能测试工具： ab (apache benchmark) , wrk, http_load, Web Bench

ab的使用：模拟并发请求100次 -c concurrency，总共请求5000次 -n requests。

```
ab -c 100 -n 5000 http://website
```

注意事项：
- 测试机器与被测试机器分开
- 不要对线上服务做压力测试
- 观察测试工具ab所在机器，以及被测试的前端机的CPU、内存、网络等都不超过最高限度的75% （top）

```
bogon% ab -c 10 -n 100 https://www.zouzhipeng.com/
This is ApacheBench, Version 2.3 <$Revision: 1807734 $>
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking www.zouzhipeng.com (be patient).....done


Server Software:        nginx/1.10.2
Server Hostname:        www.zouzhipeng.com
Server Port:            443
SSL/TLS Protocol:       TLSv1.2,ECDHE-RSA-AES128-GCM-SHA256,2048,128
TLS Server Name:        www.zouzhipeng.com

Document Path:          /
Document Length:        41106 bytes

Concurrency Level:      10 （并发数）
Time taken for tests:   33.520 seconds
Complete requests:      100
Failed requests:        0 （失败请求数，成功率95%以上才有意义）
Total transferred:      4134200 bytes
HTML transferred:       4110600 bytes
Requests per second:    2.98 [#/sec] (mean) （这个就是QPS）
Time per request:       3352.033 [ms] (mean)
Time per request:       335.203 [ms] (mean, across all concurrent requests)
Transfer rate:          120.44 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:       26  199 300.1     44    1472
Processing:    19 2983 1884.0   2765   11618
Waiting:       16 1327 1079.2   1066    5585
Total:        175 3182 1932.9   2848   11662

Percentage of the requests served within a certain time (ms)
  50%   2848
  66%   3786
  75%   4321
  80%   4742
  90%   5732
  95%   6377
  98%   8345
  99%  11662
 100%  11662 (longest request)
```

QPS如果达到极限，该如何处理？

随着QPS的增长，每个阶段需要根据时间情况来进行优化，优化的方案也与硬件条件、网络带宽息息相关。

1. QPS达到50：可以称之为小型网站，一般的服务器就可以应付，无需优化；
2. QPS达到100：假设关系型数据库的每次请求在0.01秒完成（理想状态），假设单个页面只有一个sql查询，那么100QPS意味着1秒钟完成100次请求，但是此时并不能保证数据库查询能完成100次。即瓶颈在数据库，方案：数据库缓存层、数据库的负载均衡；
3. QPS达到800：假设使用百兆带宽，意味着网站的出口实际带宽有8M左右。假设每个页面只有10K，在这个并发条件下，百兆带宽已经吃完。即带宽此时是瓶颈，方案：CDN加速、负载均衡；
4. QPS达到1000：假设使用redis或memcache缓存数据库查询数据，每个页面对memcache的请求远大于直接对DB的请求，memcache的悲观并发数在20k左右，但有可能在之前内网带宽已经吃完，表现出不稳定。方案：静态HTML缓存；
5. QPS达到2000：这个级别下，文件系统访问锁都成为了灾难，方案：做业务分离，分布式存储。

解决：首先回答怎么测试单击QPS极限值，针对不同的QPS做不同的优化。


### 高并发解决方案案例

#### 1. 流量优化
1. 防盗链处理，将恶意请求拒之门外

#### 2. 前端优化

1. 减少http请求，合并css，合并js，合并图片或将图片转至oss
2. 添加异步请求，不太重要的内容异步处理，事件驱动。
3. 启用浏览器缓存，如 localStorage 和文件压缩，如压缩图片，nginx gzip等
4. CDN 加速，同时能缓解带宽压力
5. 建立独立的图片服务器、文件服务器，或者使用对象存储

#### 3. 服务端优化

1. 页面静态化，能有效增加QPS和减小服务器压力
2. 并发处理，如多线程异步、队列

#### 4. 数据库优化

1. 数据库缓存，memcache、redis、mongodb等
2. 分库分表、分区操作
3. 读写分离
4. 负载均衡

#### 5. web服务器优化
1. 负载均衡，如使用nginx的反向代理
