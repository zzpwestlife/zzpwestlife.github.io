---
title: 高并发大流量解决方案 6 动态语言静态化
date: 2018-02-15 16:33:37
tags: 高并发
---

## 动态语言静态化

#### 1. 什么是动态语言静态化
将现有 PHP 等动态语言的逻辑代码生成为静态 HTML 文件，用户访问动态脚本时重定向到静态 HTML 文件的过程，这样会大大减轻 CPU 负载和数据库的压力。

<!-- more -->

web 工作原理回顾：用户通过浏览器的域名请求PHP文件，DNS 服务器解析域名得到 ip 地址，将 ip 返回给客户端，客户端通过 ip 找到真实的服务器并进行访问，然后找服务器 80 端口的 web 服务，nginx 判断用户请求的是否为 PHP 文件，如果是 PHP，nginx 反向代理给 fpm，因为只有 PHP 解析器（如 fpm）才能解析 PHP，fpm 将 PHP 代码进行解析，解析成 HTML，最后返回给用户浏览器。

对实时性要求不高的页面适合使用动态语言静态化。

#### 2. 为什么需要动态语言静态化

- 动态脚本通过会做逻辑计算和数据查询，访问量越大，服务器压力越大；
- 访问量大时可能造成 CPU 负载过高、数据库服务器压力过大；
- 静态化能够降低逻辑处理压力，降低数据库服务器查询压力。


#### 3. 静态化的实现方式

##### 1. 使用模板引擎，可以使用 smarty 的缓存机制生成静态 HTML 缓存文件

``` php
$smarty->cache_dir = $ROOT . '/cache'; // 缓存目录
$smarty->caching = true; // 是否开启缓存
$smarty->cache_lifetime = "3600";  // 缓存时间
$smarty->display(string template [, string cache_id [, string compile_id]]);

$smarty->clear_all_cache(); // 清除所有缓存
$smarty->clear_cache('flie.html'); // 清除指定的缓存
$smarty->clear_cache('article.html', $art_id); // 清除同一模板下的指定缓存号的缓存
```

##### 2. 利用 ob 系统函数

``` php
ob_start(): 打开输出控制缓冲
ob_get_contents(): 返回输出缓冲区内容
ob_clean(): 清空输出缓冲区
ob_end_flush()	: 冲刷出（送出）输出缓冲区内容并关闭缓冲
```
伪代码
``` php
ob_start(); // 在 HTML 代码之前开启缓冲区
输出到页面的 HTML 代码 ...
...
ob_get_contents(); // 获取中间整个的 HTML 代码
ob_end_flush()	; // 把获取到的 HTML 代码输出，并关闭缓冲区
fopen(); // 将 HTML 代码写入到指定的 HTML 文件，下次再来访问时首先判断这个 HTML 文件是否过期，如果存在且未过期，直接返回该文件即可。
```
可以判断文件的 inode 修改时间，判断是否过期。

使用 `filectime` 函数

示例
``` php
<?php
$cache_name = md5(__FILE__) . '.html';
$cache_lifetime = 3600;
if (filectime(__FILE__) <= filectime($cache_name) && file_exists($cache_name) && filectime($cache_name) + $cache_lifetime > time()) {
	include $cache_name;
	exit;
}

ob_start();
?>

<html>这里是 HTML 文件内容，会包含 PHP 计算以及数据库查询等操作</html>

<?php
$content = ob_get_contents();
ob_end_flush();

$handle = fopen($cache_name, 'w');
fwrite($handle, $content);
fclose($handle);
?>
```
